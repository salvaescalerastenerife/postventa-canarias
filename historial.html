<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Historial ¬∑ Postventa Canarias</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b5cff">
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="topbar">
    <a class="back" href="./index.html" aria-label="Volver">‚Üê</a>
    <h1>Historial</h1>
  </header>

  <main class="container">
    <section class="card">
      <h2>Filtro</h2>

      <div class="field onecol">
        <span>Fecha</span>
        <input id="fFecha" type="date" />
      </div>

      <div class="field onecol">
        <span>T√©cnico</span>
        <select id="fTec" style="width:100%; height:56px; border-radius:14px; border:1px solid var(--line); font-size:18px; padding:0 12px;">
          <option value="">Todos</option>
          <option value="JUAN PABLO CABRERA PEREZ">JUAN PABLO CABRERA PEREZ</option>
          <option value="DAMASO ROLDAN PEREZ">DAMASO ROLDAN PEREZ</option>
          <option value="PABLO ECHEDEY ESPINO ORTEGA">PABLO ECHEDEY ESPINO ORTEGA</option>
          <option value="YISHAR ROMAN MEDINA">YISHAR ROMAN MEDINA</option>
        </select>
      </div>

      <div class="btnRow" style="margin-top:12px;">
        <button id="btnRefresh" class="btn-secondary" type="button">ACTUALIZAR LISTA</button>
        <button id="btnCierre" class="btn-primary" type="button">üìÑ CIERRE DEL D√çA (PDF)</button>
      </div>

      <p class="msg ok" id="ok" aria-live="polite"></p>
      <p class="msg" id="err" aria-live="polite"></p>
    </section>

    <section class="card">
      <h2>Partes</h2>
      <div id="list"></div>
    </section>
  </main>

  <script>
    const EUR = (n) => new Intl.NumberFormat("es-ES", { style:"currency", currency:"EUR" }).format(n);

    const ok = document.getElementById("ok");
    const err = document.getElementById("err");
    const list = document.getElementById("list");
    const fFecha = document.getElementById("fFecha");
    const fTec = document.getElementById("fTec");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnCierre = document.getElementById("btnCierre");

    const PARTS_KEY = "pv_partes";
    const LAST_TEC_KEY = "pv_hist_tec";

    const todayISO = () => new Date().toISOString().slice(0,10);

    // Defaults
    fFecha.value = todayISO();
    try {
      const lastTec = localStorage.getItem(LAST_TEC_KEY) || "";
      if (lastTec) fTec.value = lastTec;
    } catch {}

    fTec.addEventListener("change", () => {
      try { localStorage.setItem(LAST_TEC_KEY, fTec.value || ""); } catch {}
    });

    const loadAll = () => {
      try { return JSON.parse(localStorage.getItem(PARTS_KEY) || "[]"); }
      catch { return []; }
    };

    const saveAll = (arr) => {
      localStorage.setItem(PARTS_KEY, JSON.stringify(arr));
    };

    // --- Helpers datos ---
    const partDate = (p) => (p?.header?.fecha || "");
    const partId = (p) => (p?.part_id || "");

    // t√©cnicos asociados al parte (1 o 2)
    const partTechs = (p) => {
      const h = p?.header || {};
      const t = [];
      if (h.tecnico) t.push(h.tecnico);
      if (h.tecnico1) t.push(h.tecnico1);
      if (h.tecnico2) t.push(h.tecnico2);
      return [...new Set(t)].filter(Boolean);
    };

    // Estado ENVIADO por t√©cnico (nuevo), fallback al viejo sent_at
    const isSentForTec = (p, tec) => {
      if (!tec) return Boolean(p?.sent_at); // si est√° en "Todos", mostramos estado global (legacy)
      const sb = p?.sent_by || {};
      if (sb && sb[tec] && sb[tec].sent_at) return true;
      // compatibilidad retro si hab√≠a sent_at global
      return Boolean(p?.sent_at);
    };

    // Garantiza part_id en todos los registros (retrocompatible)
    const ensureIds = (all) => {
      let changed = false;
      const now = Date.now();
      const out = all.map((p, i) => {
        if (p && !p.part_id) {
          changed = true;
          const f = p?.header?.fecha || "nodate";
          const idc = p?.header?.idCliente || "noclient";
          const typ = p?.tipo || "tipo";
          const ts = p?.saved_at || new Date(now + i).toISOString();
          return { ...p, part_id: `${f}::${idc}::${typ}::${ts}::${i}` };
        }
        return p;
      });
      if (changed) saveAll(out);
      return out;
    };

    // Total estimado para instalaci√≥n si no guardaste totales
    const computeTotalFallback = (p) => {
      const d = p?.datos || {};
      const t = p?.tarifas || {};
      const tipo = p?.tipo || "";

      const toN = (x) => (Number.isFinite(Number(x)) ? Number(x) : 0);

      if (tipo === "instalacion") {
        const hi = toN(d.horas_inst);
        const hd = toN(d.horas_despl);
        const km = toN(d.kms);
        const co = toN(d.comida);
        const ma = toN(d.material);
        const fu = d.furgon ? toN(t.FURGON ?? 80) : 0;

        const P_INST = toN(t.P_INST ?? 27.95);
        const P_DESPL = toN(t.P_DESPL ?? 19.28);
        const P_KM = toN(t.P_KM ?? 0.31);
        const TEC = 2;

        const a = hi * P_INST * TEC;
        const b = hd * P_DESPL * TEC;
        const c = km * P_KM;
        return a + b + c + co + ma + fu;
      }

      return toN(p?.totales?.total ?? 0);
    };

    // XSS escape simple
    const esc = (s) => String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const render = () => {
      ok.textContent = "";
      err.textContent = "";

      let all = ensureIds(loadAll());

      const date = (fFecha.value || "").trim();
      const tec = (fTec.value || "").trim();

      const filtered = all
        .filter(p => !date || partDate(p) === date)
        .filter(p => !tec || partTechs(p).includes(tec))
        .sort((a,b) => (b.saved_at || "").localeCompare(a.saved_at || ""));

      if (!filtered.length) {
        list.innerHTML = `<p style="color:var(--muted); font-weight:800;">No hay partes para ese filtro.</p>`;
        return;
      }

      list.innerHTML = filtered.map((p) => {
        const tipo = p.tipo || "‚Äî";
        const id = p.header?.idCliente || "‚Äî";
        const fecha = p.header?.fecha || "‚Äî";
        const techs = partTechs(p).join(" + ") || "‚Äî";

        const tot = (typeof p?.totales?.total === "number") ? p.totales.total : computeTotalFallback(p);
        const sent = isSentForTec(p, tec) ? "ENVIADO" : "PENDIENTE";
        const sentColor = isSentForTec(p, tec) ? "#15803d" : "#b45309";

        return `
          <div class="card" style="margin:12px 0; box-shadow:none;">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <div style="font-weight:1000; font-size:18px;">${esc(tipo).toUpperCase()} ¬∑ ${esc(id)}</div>
              <div style="font-weight:1000; font-size:14px; color:${sentColor};">${sent}</div>
            </div>

            <div style="margin-top:8px; color:var(--muted); font-weight:800;">
              <div>Fecha: <strong style="color:var(--text)">${esc(fecha)}</strong></div>
              <div>T√©cnicos: <strong style="color:var(--text)">${esc(techs)}</strong></div>
              <div>Total: <strong style="color:var(--text)">${esc(EUR(tot))}</strong></div>
            </div>

            <div class="btnRow" style="margin-top:12px;">
              <button class="btn-secondary" type="button" data-act="del" data-id="${esc(p.part_id)}">BORRAR</button>
            </div>
          </div>
        `;
      }).join("");

      // BORRAR por part_id (robusto)
      list.querySelectorAll("button[data-act='del']").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          if (!id) return;

          const okDel = confirm("¬øBorrar este parte del tel√©fono?");
          if (!okDel) return;

          const allNow = loadAll();
          const next = allNow.filter(p => (p?.part_id || "") !== id);
          saveAll(next);
          render();
        });
      });
    };

    btnRefresh.addEventListener("click", render);

    // ---------- PDF Cierre del d√≠a (por t√©cnico) ----------
    const requireTecSelected = () => {
      const tec = (fTec.value || "").trim();
      if (!tec) {
        err.textContent = "Selecciona un t√©cnico (no puede ser 'Todos') para generar su cierre.";
        return null;
      }
      return tec;
    };

    const dataUrlToJpeg = (src) => new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const MAX_W = 1400;
        let w = img.naturalWidth || img.width;
        let h = img.naturalHeight || img.height;

        if (w > MAX_W) {
          h = Math.round(h * (MAX_W / w));
          w = MAX_W;
        }

        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);

        resolve(c.toDataURL("image/jpeg", 0.85));
      };
      img.onerror = reject;
      img.src = src;
    });

    async function addPhotos(doc, y, title, images) {
      const M = 14;
      const W = 210 - M * 2;

      if (!images || !images.length) return y;

      if (y > 240) { doc.addPage(); y = 16; }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text(title, M, y);
      y += 8;

      const gap = 6;
      const cellW = (W - gap) / 2;
      const cellH = 60;

      const getImgSize = (dataUrl) => new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve({ w: img.naturalWidth || img.width, h: img.naturalHeight || img.height });
        img.onerror = reject;
        img.src = dataUrl;
      });

      let col = 0;
      let x = M;

      for (let i = 0; i < images.length; i++) {
        if (y + cellH > 285) {
          doc.addPage();
          y = 16;
          col = 0;
          x = M;
        }

        doc.setDrawColor(220);
        doc.rect(x, y, cellW, cellH);

        const pad = 2;
        const maxW = cellW - pad * 2;
        const maxH = cellH - pad * 2;

        let iw = 1, ih = 1;
        try {
          const sz = await getImgSize(images[i]);
          iw = sz.w; ih = sz.h;
        } catch (_) {}

        const scale = Math.min(maxW / iw, maxH / ih);
        const dw = iw * scale;
        const dh = ih * scale;

        const dx = x + (cellW - dw) / 2;
        const dy = y + (cellH - dh) / 2;

        doc.addImage(images[i], "JPEG", dx, dy, dw, dh);

        col++;
        if (col === 2) { col = 0; x = M; y += (cellH + gap); }
        else { x = M + cellW + gap; }
      }

      if (col === 1) y += (cellH + gap);
      return y;
    }

    btnCierre.addEventListener("click", async () => {
      ok.textContent = "";
      err.textContent = "";

      const tec = requireTecSelected();
      if (!tec) return;

      const date = (fFecha.value || "").trim();
      if (!date) {
        err.textContent = "Selecciona una fecha.";
        return;
      }

      let all = ensureIds(loadAll());

      const parts = all
        .filter(p => partDate(p) === date)
        .filter(p => partTechs(p).includes(tec));

      if (!parts.length) {
        err.textContent = "No hay partes para ese t√©cnico en esa fecha.";
        return;
      }

      try {
const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "mm", format: "a4" });

        const M = 14;
        const W = 210 - M * 2;
        let y = 16;

        // ===== PORTADA (solo portada) =====
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("CIERRE DEL D√çA", M, y);

        y += 10;
        doc.setFontSize(12);
        doc.text(`T√©cnico: ${tec}`, M, y);

        y += 7;
        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        doc.text(`Fecha: ${date}`, M, y);

        y += 7;
        doc.text(`N¬∫ de partes: ${parts.length}`, M, y);

        y += 8;
        doc.setDrawColor(30);
        doc.setLineWidth(0.3);
        doc.line(M, y, 210 - M, y);

        // Las partes empiezan SIEMPRE en p√°gina nueva
        doc.addPage();
        y = 16;
let sumTotal = 0;

for (let i = 0; i < parts.length; i++) {
  const p = parts[i];

  // ‚úÖ Cada parte empieza en p√°gina nueva (menos la primera)
  if (i > 0) {
    doc.addPage();
    y = 16;
  }

  const tipo = (p.tipo || "‚Äî").toUpperCase();
  const id = p.header?.idCliente || "‚Äî";
  const techs = partTechs(p).join(" + ") || "‚Äî";

  const tot = (typeof p?.totales?.total === "number")
    ? p.totales.total
    : computeTotalFallback(p);

  sumTotal += (Number.isFinite(tot) ? tot : 0);

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text(`${i + 1}. ${tipo} ¬∑ Cliente ${id}`, M, y);
  y += 6;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10.5);

  doc.text(`T√©cnicos en parte: ${techs}`, M, y);
  y += 6;

// === DETALLE POR TIPO ===
  const d = p?.datos || {};
  const t = p?.tarifas || {};
  const toN = (x) => (Number.isFinite(Number(x)) ? Number(x) : 0);

  if (p.tipo === "instalacion") {
    const hi = toN(d.horas_inst);
    const hd = toN(d.horas_despl);
    const km = toN(d.kms);
    const co = toN(d.comida);
    const ma = toN(d.material);
    const fu = d.furgon ? toN(t.FURGON ?? 80) : 0;

    const P_INST = toN(t.P_INST ?? 27.95);
    const P_DESPL = toN(t.P_DESPL ?? 19.28);
    const P_KM = toN(t.P_KM ?? 0.31);
    const TEC = 2;

    const subtotalInst = hi * P_INST * TEC;
    const subtotalDespl = hd * P_DESPL * TEC;
    const subtotalKm = km * P_KM;

    doc.text(`Instalaci√≥n: ${hi.toFixed(1).replace(".", ",")} h x2 = ${EUR(subtotalInst)}`, M, y); y += 5;
    doc.text(`Desplazamiento: ${hd.toFixed(1).replace(".", ",")} h x2 = ${EUR(subtotalDespl)}`, M, y); y += 5;
    doc.text(`Kil√≥metros: ${String(km).replace(".", ",")} = ${EUR(subtotalKm)}`, M, y); y += 5;
    doc.text(`Comida: ${EUR(co)}`, M, y); y += 5;
    doc.text(`Material: ${EUR(ma)}`, M, y); y += 5;
    doc.text(`Furg√≥n: ${EUR(fu)}`, M, y); y += 5;
  }

  if (p.tipo === "reparacion") {
    const hr = toN(d.horas_rep);
    const hd = toN(d.horas_despl);
    const km = toN(d.kms);
    const co = toN(d.comida);
    const maBase = toN(d.material);
    const bat = toN(d.bateria);

    const P_REP = toN(t.P_REP ?? 27.95);
    const P_DESPL = toN(t.P_DESPL ?? 19.28);
    const P_KM = toN(t.P_KM ?? 0.31);

    const subtotalRep = hr * P_REP;
    const subtotalDespl = hd * P_DESPL;
    const subtotalKm = km * P_KM;

    doc.text(`Reparaci√≥n: ${hr.toFixed(1).replace(".", ",")} h = ${EUR(subtotalRep)}`, M, y); y += 5;
    doc.text(`Desplazamiento: ${hd.toFixed(1).replace(".", ",")} h = ${EUR(subtotalDespl)}`, M, y); y += 5;
    doc.text(`Kil√≥metros: ${String(km).replace(".", ",")} = ${EUR(subtotalKm)}`, M, y); y += 5;
    doc.text(`Comida: ${EUR(co)}`, M, y); y += 5;
    doc.text(`Material: ${EUR(maBase)}`, M, y); y += 5;
    if (bat > 0) { doc.text(`Bater√≠a: ${EUR(bat)}`, M, y); y += 5; }
  }

  if (p.tipo === "mantenimiento") {
    const fijo = toN(d.fijo) || toN(p?.totales?.total) || 0;
    doc.text(`Mantenimiento (fijo): ${EUR(fijo)}`, M, y); y += 5;
  }

  y += 2;
  doc.setFont("helvetica", "bold");
  doc.text(`Total parte: ${EUR(tot)}`, M, y);
  y += 8;
  doc.setFont("helvetica", "normal");

  // Observaciones
  const obs = (p.observaciones || "").trim() || "‚Äî";
  const obsLines = doc.splitTextToSize(`Obs: ${obs}`, W);
  doc.text(obsLines, M, y);
  y += obsLines.length * 4.6 + 4;

  // Fotos
  const tImgsRaw = p?.fotos?.ticket_dataurls || [];
  const mImgsRaw = p?.fotos?.material_dataurls || [];

  const tImgs = [];
  const mImgs = [];
  for (const u of tImgsRaw) { try { tImgs.push(await dataUrlToJpeg(u)); } catch (_) {} }
  for (const u of mImgsRaw) { try { mImgs.push(await dataUrlToJpeg(u)); } catch (_) {} }

  y = await addPhotos(doc, y, `FOTOS ¬∑ Ticket (${tImgs.length})`, tImgs);
  y = await addPhotos(doc, y, `FOTOS ¬∑ Material (${mImgs.length})`, mImgs);
}

// ‚úÖ Resumen final SIEMPRE en p√°gina nueva
doc.addPage();
y = 16;
doc.setFont("helvetica", "bold");
doc.setFontSize(14);
doc.text(`TOTAL DEL D√çA: ${EUR(sumTotal)}`, M, y);

        const pdfBlob = doc.output("blob");
        const filename = `Cierre_${date}_${tec.replaceAll(" ", "_")}.pdf`;
        const file = new File([pdfBlob], filename, { type: "application/pdf" });

        // Marca ENVIADO SOLO para ese t√©cnico (sent_by)
        const batchId = `${date}::${tec}::${Date.now()}`;
        const nowISO = new Date().toISOString();

        const updated = all.map(p => {
          if (partDate(p) !== date) return p;
          if (!partTechs(p).includes(tec)) return p;

          const sent_by = { ...(p.sent_by || {}) };
          sent_by[tec] = { sent_at: nowISO, batch_id: batchId };
          return { ...p, sent_by };
        });

        saveAll(updated);

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files: [file], title: "Cierre del d√≠a", text: "Adjunto cierre del d√≠a en PDF." });
          ok.textContent = "Cierre compartido ‚úÖ";
        } else {
          const url = URL.createObjectURL(pdfBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
          ok.textContent = "PDF descargado (fallback) ‚úÖ";
        }

        render();
      } catch (e) {
        console.error(e);
        err.textContent = "ERROR PDF: " + (e?.message ? e.message : String(e));
      }
    });

    // init
    render();
  </script>

<style>
.btnRow{ display:grid; gap:10px; }
</style>
</body>
</html>
