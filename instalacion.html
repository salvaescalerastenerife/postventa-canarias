<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Instalaci√≥n ¬∑ Postventa Canarias</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b5cff">
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="topbar">
    <a class="back" href="./index.html" aria-label="Volver">‚Üê</a>
    <h1>Instalaci√≥n</h1>
  </header>

  <main class="container">
    <!-- Cabecera -->
    <section class="card">
      <div class="meta">
        <div><strong>Intervenci√≥n:</strong> Instalaci√≥n</div>
        <div><strong>Fecha:</strong> <span id="mFecha">‚Äî</span></div>
        <div><strong>ID Cliente:</strong> <span id="mId">‚Äî</span></div>
        <div><strong>T√©cnicos:</strong> 2</div>
      </div>
    </section>

    <!-- Horas instalaci√≥n -->
    <section class="card">
      <div class="rowhead">
        <h2>Horas de instalaci√≥n</h2>
        <div class="rate">27,95 ‚Ç¨/h</div>
      </div>

<div class="stepper">
  <button type="button" class="step" data-target="hInst" data-delta="-0.5">‚àí0,5</button>
  <div class="stepval"><span id="hInstText">0,0</span> h</div>
  <button type="button" class="step" data-target="hInst" data-delta="0.5">+0,5</button>
</div>

<div class="quick">
  <button class="qdelta" type="button" data-target="hInst" data-delta="1">+1</button>
  <button class="qdelta" type="button" data-target="hInst" data-delta="2">+2</button>
  <button class="qdelta" type="button" data-target="hInst" data-delta="4">+4</button>
  <button class="qdelta" type="button" data-target="hInst" data-delta="8">+8</button>
  <button class="qreset" type="button" data-target="hInst">Reset</button>
</div>

<input id="hInst" type="hidden" value="0" />

      <div class="totline">
        <span>Total instalaci√≥n</span>
        <strong id="tInst">0,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Horas desplazamiento -->
    <section class="card">
      <div class="rowhead">
        <h2>Horas de desplazamiento</h2>
        <div class="rate">19,28 ‚Ç¨/h</div>
      </div>

<div class="stepper">
  <button type="button" class="step" data-target="hDespl" data-delta="-0.5">‚àí0,5</button>

  <div class="stepval">
    <span id="hDesplText">0,0</span> h
  </div>

  <button type="button" class="step" data-target="hDespl" data-delta="0.5">+0,5</button>
</div>

<div class="quick">
  <button class="qdelta" type="button" data-target="hDespl" data-delta="1">+1</button>
  <button class="qdelta" type="button" data-target="hDespl" data-delta="2">+2</button>
  <button class="qdelta" type="button" data-target="hDespl" data-delta="4">+4</button>
  <button class="qdelta" type="button" data-target="hDespl" data-delta="8">+8</button>
  <button class="qreset" type="button" data-target="hDespl">Reset</button>
</div>

<input id="hDespl" type="hidden" value="0" />

      <div class="totline">
        <span>Total desplazamiento</span>
        <strong id="tDespl">0,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Kil√≥metros -->
    <section class="card">
      <div class="rowhead">
        <h2>Kil√≥metros</h2>
        <div class="rate">0,31 ‚Ç¨/km</div>
      </div>

      <label class="field onecol">
        <input id="kms" inputmode="numeric" pattern="[0-9]*" placeholder="0" />
      </label>

      <div class="totline">
        <span>Total km</span>
        <strong id="tKm">0,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Comida -->
    <section class="card">
      <div class="rowhead">
        <h2>Comida</h2>
        <div class="rate">‚Ç¨</div>
      </div>

      <label class="field onecol">
        <input id="comida" inputmode="decimal" placeholder="0" />
      </label>

<div class="attach">
  <button type="button" class="btn-attach" id="btnCamTicket">üì∑ Sacar foto</button>

  <label class="btn-attach alt">
    üñºÔ∏è Fototeca
    <input id="fotoTicket" type="file" accept="image/*" />
  </label>

  <span class="count" id="cTicket">0 fotos</span>
</div>
    </section>

    <!-- Material -->
    <section class="card">
      <div class="rowhead">
        <h2>Consumibles / Material</h2>
        <div class="rate">‚Ç¨</div>
      </div>

      <label class="field onecol">
        <input id="material" inputmode="decimal" placeholder="0" />
      </label>

<div class="attach">
  <button type="button" class="btn-attach" id="btnCamMaterial">üì∑ Sacar foto</button>

  <label class="btn-attach alt">
    üñºÔ∏è Fototeca
    <input id="fotoMaterial" type="file" accept="image/*" />
  </label>

  <span class="count" id="cMat">0 fotos</span>
</div>
    </section>

    <!-- Furg√≥n -->
    <section class="card">
      <div class="rowhead">
        <h2>Furg√≥n</h2>
        <div class="rate">80,00 ‚Ç¨</div>
      </div>

      <div class="switchrow">
        <label class="switch">
          <input id="furgonOn" type="checkbox" checked />
          <span class="slider"></span>
        </label>
        <div class="swtext">
          <div class="swtitle">Aplicar furg√≥n</div>
          <div class="swsub">Por defecto activo</div>
        </div>
        <strong id="tFurgon">80,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Observaciones -->
    <section class="card">
      <h2>Observaciones</h2>
      <textarea id="obs" rows="4" placeholder="Escribe aqu√≠ si hay algo que anotar..."></textarea>
    </section>

    <!-- Resumen -->
    <section class="card">
      <h2>Resumen</h2>

      <div class="sumline"><span>Instalaci√≥n</span><strong id="sInst">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Desplazamiento</span><strong id="sDespl">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Kil√≥metros</span><strong id="sKm">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Comida</span><strong id="sComida">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Material</span><strong id="sMat">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Furg√≥n</span><strong id="sFurgon">80,00 ‚Ç¨</strong></div>

      <div class="sumtotal">
        <span>TOTAL</span>
        <strong id="total">80,00 ‚Ç¨</strong>
      </div>
    </section>

    <section class="card">
<div class="btnRow">
  <button id="btnGuardar" class="btn-primary" type="button">GUARDAR (LOCAL)</button>
  <button id="btnCompartir" class="btn-secondary" type="button">COMPARTIR (WhatsApp)</button>
  <button id="btnPDF" class="btn-secondary" type="button">ENVIAR PDF (WhatsApp)</button>
</div>

<p class="msg ok" id="ok" aria-live="polite"></p>
<p class="msg" id="err" aria-live="polite"></p>
    </section>
    <!-- MODAL C√ÅMARA -->
<div id="camModal" class="camModal" hidden>
  <div class="camPanel">
    <div class="camTop">
      <strong id="camTitle">C√°mara</strong>
      <button type="button" id="camClose" class="camClose">‚úï</button>
    </div>

    <video id="camVideo" playsinline autoplay></video>

    <canvas id="camCanvas" hidden></canvas>

    <div class="camBottom">
      <button type="button" id="camShot" class="camBtnPrimary">CAPTURAR</button>
      <button type="button" id="camUse" class="camBtn" disabled>USAR FOTO</button>
      <button type="button" id="camRetake" class="camBtn" disabled>REPETIR</button>
    </div>

    <p id="camMsg" class="camMsg"></p>
  </div>
</div>
  </main>

  <script>
    // ------- Utilidades -------
    const EUR = (n) => new Intl.NumberFormat("es-ES", { style:"currency", currency:"EUR" }).format(n);

    // Acepta "1,5" o "1.5"
    const toNum = (v) => {
      if (!v) return 0;
      const s = String(v).trim().replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };

    const clamp0 = (n) => (n < 0 ? 0 : n);

    // Tarifas
    const P_INST = 27.95;
    const P_DESPL = 19.28;
    const P_KM = 0.31;
    const FURGON = 80.00;
    const TECNICOS_INST = 2;
    // ------- Cargar cabecera -------
    const header = (() => {
      try { return JSON.parse(localStorage.getItem("pv_header") || "{}"); }
      catch { return {}; }
    })();

    // Guardas por si alguien entra directo
    document.getElementById("mFecha").textContent = header.fecha || "‚Äî";
    document.getElementById("mId").textContent = header.idCliente || "‚Äî";

    // ------- Inputs -------
    const hInst = document.getElementById("hInst");
    const hDespl = document.getElementById("hDespl");
    const kms = document.getElementById("kms");
    const comida = document.getElementById("comida");
    const material = document.getElementById("material");
    const furgonOn = document.getElementById("furgonOn");

    const fotoTicket = document.getElementById("fotoTicket");
    const fotoMaterial = document.getElementById("fotoMaterial");
    const cTicket = document.getElementById("cTicket");
    const cMat = document.getElementById("cMat");

    const setCounts = () => {
      cTicket.textContent = `${fotoTicket.files?.length || 0} fotos`;
      cMat.textContent = `${fotoMaterial.files?.length || 0} fotos`;
    };
    fotoTicket.addEventListener("change", setCounts);
    fotoMaterial.addEventListener("change", setCounts);

    // ------- C√°lculos -------
    const tInst = document.getElementById("tInst");
    const tDespl = document.getElementById("tDespl");
    const tKm = document.getElementById("tKm");
    const tFurgon = document.getElementById("tFurgon");

    const sInst = document.getElementById("sInst");
    const sDespl = document.getElementById("sDespl");
    const sKm = document.getElementById("sKm");
    const sComida = document.getElementById("sComida");
    const sMat = document.getElementById("sMat");
    const sFurgon = document.getElementById("sFurgon");
    const totalEl = document.getElementById("total");

    const recalc = () => {
      const hi = clamp0(toNum(hInst.value));
      const hd = clamp0(toNum(hDespl.value));
      const km = clamp0(toNum(kms.value));
      const co = clamp0(toNum(comida.value));
      const ma = clamp0(toNum(material.value));
      const fu = furgonOn.checked ? FURGON : 0;

      const a = hi * P_INST * TECNICOS_INST;
      const b = hd * P_DESPL;
      const c = km * P_KM;

      tInst.textContent = EUR(a);
      tDespl.textContent = EUR(b);
      tKm.textContent = EUR(c);

      const tf = EUR(fu);
      tFurgon.textContent = tf;

      sInst.textContent = EUR(a);
      sDespl.textContent = EUR(b);
      sKm.textContent = EUR(c);
      sComida.textContent = EUR(co);
      sMat.textContent = EUR(ma);
      sFurgon.textContent = tf;

      const tot = a + b + c + co + ma + fu;
      totalEl.textContent = EUR(tot);
    };

    ["input","change"].forEach(evt => {
      hInst.addEventListener(evt, recalc);
      hDespl.addEventListener(evt, recalc);
      kms.addEventListener(evt, recalc);
      comida.addEventListener(evt, recalc);
      material.addEventListener(evt, recalc);
      furgonOn.addEventListener(evt, recalc);
    });

// --- STEPPER horas (saltos de 0,5 hasta 9h) ---
const setHalfHour = (val) => {
  let v = Math.round(val * 2) / 2; // fuerza m√∫ltiplos de 0,5
  if (v < 0) v = 0;
  if (v > 9) v = 9;
  return v;
};

const fmtHours = (v) => String(v.toFixed(1)).replace(".", ",");

// Actualiza los textos visibles
const syncDisplays = () => {
  const hi = toNum(hInst.value || 0);
  const hd = toNum(hDespl.value || 0);
  const ti = document.getElementById("hInstText");
  const td = document.getElementById("hDesplText");
  if (ti) ti.textContent = fmtHours(hi);
  if (td) td.textContent = fmtHours(hd);
};

// Botones +/- 0,5
document.querySelectorAll(".step").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    const delta = Number(btn.dataset.delta);
    const el = document.getElementById(target);
    const cur = toNum(el.value || 0);
    el.value = setHalfHour(cur + delta);
    syncDisplays();
    recalc();
  });
});

// Chips +1 +2 +4 +8
document.querySelectorAll(".qdelta").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    const delta = Number(btn.dataset.delta);
    const el = document.getElementById(target);
    const cur = toNum(el.value || 0);
    el.value = setHalfHour(cur + delta);
    syncDisplays();
    recalc();
  });
});

// Reset
document.querySelectorAll(".qreset").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;
    const el = document.getElementById(target);
    el.value = 0;
    syncDisplays();
    recalc();
  });
});

// Inicializaci√≥n
syncDisplays();
recalc();
    // ------- Guardado local -------
    const ok = document.getElementById("ok");
    const err = document.getElementById("err");
    const btnGuardar = document.getElementById("btnGuardar");

    btnGuardar.addEventListener("click", async () => {
      ok.textContent = "";
      err.textContent = "";

      // Validaci√≥n m√≠nima
      if (!header.idCliente) {
        err.textContent = "Falta ID Cliente (vuelve atr√°s y cr√©alo desde Nuevo Parte).";
        return;
      }

      const payload = {
        header,
        tipo: "instalacion",
        tarifas: { P_INST, P_DESPL, P_KM, FURGON },
        datos: {
          horas_inst: toNum(hInst.value),
          horas_despl: toNum(hDespl.value),
          kms: toNum(kms.value),
          comida: toNum(comida.value),
          material: toNum(material.value),
          furgon: furgonOn.checked
        },
        observaciones: document.getElementById("obs").value || "",
        fotos: {
  ticket_count: getTicketCount(),
  material_count: getMaterialCount(),
  ticket_dataurls: ticketShots,
  material_dataurls: materialShots
},
        saved_at: new Date().toISOString()
      };

      // Guardamos un array de partes
      const key = "pv_partes";
      let arr = [];
      try { arr = JSON.parse(localStorage.getItem(key) || "[]"); } catch {}
      arr.push(payload);
      localStorage.setItem(key, JSON.stringify(arr));

      ok.textContent = "Guardado en el m√≥vil ‚úÖ";
    });
    // -------- C√°mara propia (evita ‚Äúc√°mara negra‚Äù del input file en iOS) --------
const camModal = document.getElementById("camModal");
camModal.hidden = true;
const camVideo = document.getElementById("camVideo");
const camCanvas = document.getElementById("camCanvas");
const camShot = document.getElementById("camShot");
const camUse = document.getElementById("camUse");
const camRetake = document.getElementById("camRetake");
const camClose = document.getElementById("camClose");
const camMsg = document.getElementById("camMsg");
const camTitle = document.getElementById("camTitle");

const btnCamTicket = document.getElementById("btnCamTicket");
const btnCamMaterial = document.getElementById("btnCamMaterial");

// guardamos las fotos en memoria (DataURL). Luego podr√°s meterlas en localStorage o exportar.
let ticketShots = [];
let materialShots = [];

let currentTarget = null; // "ticket" | "material"
let stream = null;
let lastDataUrl = null;

const getTicketCount = () => (ticketShots.length + (fotoTicket.files?.length || 0));
const getMaterialCount = () => (materialShots.length + (fotoMaterial.files?.length || 0));

const updatePhotoCounts = () => {
  cTicket.textContent = `${getTicketCount()} fotos`;
  cMat.textContent = `${getMaterialCount()} fotos`;
};

const openCam = async (target) => {
  currentTarget = target;
  lastDataUrl = null;
  camMsg.textContent = "";
  camUse.disabled = true;
  camRetake.disabled = true;
  camShot.disabled = false;

  camTitle.textContent = target === "ticket" ? "C√°mara ¬∑ Ticket" : "C√°mara ¬∑ Material";

  camModal.hidden = false;

  try {
    // iOS: mejor pedir environment pero con fallback si no lo da
    const constraints = { video: { facingMode: { ideal: "environment" } }, audio: false };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    camVideo.srcObject = stream;
    await camVideo.play();
  } catch (e) {
    camMsg.textContent = "No se pudo abrir la c√°mara. Usa Fototeca si hace falta.";
    // Cerrar modal si falla
    closeCam();
  }
};

const closeCam = () => {
  camModal.hidden = true;
  camMsg.textContent = "";
  lastDataUrl = null;

  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  camVideo.srcObject = null;
};

camClose.addEventListener("click", closeCam);

// Capturar frame del video
camShot.addEventListener("click", () => {
  if (!camVideo.videoWidth || !camVideo.videoHeight) {
    camMsg.textContent = "La c√°mara a√∫n no est√° lista. Espera 1 segundo y prueba otra vez.";
    return;
  }

  const w = camVideo.videoWidth;
  const h = camVideo.videoHeight;

  camCanvas.width = w;
  camCanvas.height = h;
  const ctx = camCanvas.getContext("2d");
  ctx.drawImage(camVideo, 0, 0, w, h);

  lastDataUrl = camCanvas.toDataURL("image/jpeg", 0.85);

  camUse.disabled = false;
  camRetake.disabled = false;
  camShot.disabled = true;
  camMsg.textContent = "Foto capturada ‚úÖ";
});

// Usar foto capturada
camUse.addEventListener("click", () => {
  if (!lastDataUrl) return;

  if (currentTarget === "ticket") ticketShots.push(lastDataUrl);
  if (currentTarget === "material") materialShots.push(lastDataUrl);

  updatePhotoCounts();
  closeCam();
});

// Repetir
camRetake.addEventListener("click", () => {
  lastDataUrl = null;
  camUse.disabled = true;
  camRetake.disabled = true;
  camShot.disabled = false;
  camMsg.textContent = "";
});

// Botones
btnCamTicket.addEventListener("click", () => openCam("ticket"));
btnCamMaterial.addEventListener("click", () => openCam("material"));

// Actualiza contadores tambi√©n cuando el user usa Fototeca
fotoTicket.addEventListener("change", updatePhotoCounts);
fotoMaterial.addEventListener("change", updatePhotoCounts);

// Inicializa
updatePhotoCounts();
    // -------- COMPARTIR (WhatsApp) --------
const btnCompartir = document.getElementById("btnCompartir");

// Alineaci√≥n ‚Äútipo PDF‚Äù para WhatsApp (monoespaciado)
const padR = (s, n) => String(s).padEnd(n, " ");
const padL = (s, n) => String(s).padStart(n, " ");
const fmtH = (n) => String(Number(n || 0).toFixed(1)).replace(".", ",") + " h";

function buildWhatsAppText() {
  const hi = clamp0(toNum(hInst.value));
  const hd = clamp0(toNum(hDespl.value));
  const km = clamp0(toNum(kms.value));
  const co = clamp0(toNum(comida.value));
  const ma = clamp0(toNum(material.value));
  const fu = furgonOn.checked ? FURGON : 0;

  // IMPORTES (ojo: instalaci√≥n √ó 2 t√©cnicos)
  const TECNICOS = (typeof TECNICOS_INST !== "undefined") ? TECNICOS_INST : 2;
  const impInst = hi * P_INST * TECNICOS;
  const impDespl = hd * P_DESPL;
  const impKm = km * P_KM;

  const total = impInst + impDespl + impKm + co + ma + fu;

  const obs = (document.getElementById("obs").value || "").trim();

  // Contadores de fotos (si tienes c√°mara propia: ticketShots/materialShots existen)
const ticketCount = getTicketCount();
const materialCount = getMaterialCount();

  // Anchos para que quede ‚Äúcuadrado‚Äù
  const W1 = 18; // etiqueta
  const W2 = 10; // horas/km
  const W3 = 14; // importe

  const lines = [];
  lines.push("üßæ PARTE ¬∑ INSTALACI√ìN");
  lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  lines.push(`Fecha: ${header.fecha || "‚Äî"}`);
  lines.push(`ID Cliente: ${header.idCliente || "‚Äî"}`);
  lines.push(`T√©cnicos: ${TECNICOS}`);
  lines.push("");

  lines.push("DETALLE");
  lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  lines.push(
    padR("Horas instalaci√≥n", W1) + " " +
    padL(fmtH(hi), W2) + "  " +
    padL(EUR(impInst), W3)
  );
  lines.push(
    padR("Horas despl.", W1) + " " +
    padL(fmtH(hd), W2) + "  " +
    padL(EUR(impDespl), W3)
  );
  lines.push(
    padR("Kil√≥metros", W1) + " " +
    padL(String(km).replace(".", ","), W2) + "  " +
    padL(EUR(impKm), W3)
  );
  lines.push(
    padR("Comida", W1) + " " +
    padL("", W2) + "  " +
    padL(EUR(co), W3)
  );
  lines.push(
    padR("Material", W1) + " " +
    padL("", W2) + "  " +
    padL(EUR(ma), W3)
  );
  lines.push(
    padR("Furg√≥n", W1) + " " +
    padL(furgonOn.checked ? "S√≠" : "No", W2) + "  " +
    padL(EUR(fu), W3)
  );

  lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  lines.push(padR("TOTAL", W1 + W2 + 2) + padL(EUR(total), W3));
  lines.push("");

  lines.push("ADJUNTOS");
  lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  lines.push(`Ticket comida: ${ticketCount} foto(s)`);
  lines.push(`Material:      ${materialCount} foto(s)`);
  lines.push("");

  lines.push("OBSERVACIONES");
  lines.push("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ");
  lines.push(obs ? obs : "‚Äî");

  // WhatsApp se ve mejor en bloque monoespaciado
  return "```" + "\n" + lines.join("\n") + "\n" + "```";
}

btnCompartir.addEventListener("click", async () => {
  err.textContent = "";
  ok.textContent = "";

  if (!header.idCliente) {
    err.textContent = "Falta ID Cliente (vuelve atr√°s y cr√©alo desde Nuevo Parte).";
    return;
  }

  const text = buildWhatsAppText();

  // 1) Intento: share sheet iOS (elige WhatsApp)
  if (navigator.share) {
    try {
      await navigator.share({ text });
      ok.textContent = "Compartido ‚úÖ";
      return;
    } catch (e) {
      // si cancelas o falla, hacemos fallback a URL
    }
  }

  // 2) Fallback: abrir WhatsApp con texto
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
});
    // -------- PDF + COMPARTIR (con fotos) --------
const btnPDF = document.getElementById("btnPDF");

// File -> DataURL (raw)
const fileToDataURL = (file) => new Promise((resolve, reject) => {
  const r = new FileReader();
  r.onload = () => resolve(r.result);
  r.onerror = reject;
  r.readAsDataURL(file);
});

// DataURL (cualquier formato: HEIC/PNG/JPG) -> JPEG DataURL
const dataUrlToJpeg = (src) => new Promise((resolve, reject) => {
  const img = new Image();
  img.onload = () => {
    // downscale para que el PDF no pese una barbaridad
    const MAX_W = 1400;
    let w = img.naturalWidth || img.width;
    let h = img.naturalHeight || img.height;

    if (w > MAX_W) {
      h = Math.round(h * (MAX_W / w));
      w = MAX_W;
    }

    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    const ctx = c.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    resolve(c.toDataURL("image/jpeg", 0.85));
  };
  img.onerror = reject;
  img.src = src;
});

// File -> JPEG DataURL (robusto)
const fileToJpegDataURL = async (file) => {
  const raw = await fileToDataURL(file);
  return await dataUrlToJpeg(raw);
};

// Coge TODAS las fotos disponibles: (a) c√°mara propia arrays + (b) fototeca files
async function collectImages() {
  const ticket = [];
  const material = [];

  // (a) c√°mara propia (aunque ya viene JPEG, lo normalizamos igual)
  if (typeof ticketShots !== "undefined") {
    for (const u of ticketShots) ticket.push(await dataUrlToJpeg(u));
  }
  if (typeof materialShots !== "undefined") {
    for (const u of materialShots) material.push(await dataUrlToJpeg(u));
  }

  // (b) fototeca (File -> JPEG)
  if (fotoTicket?.files?.length) {
    for (const f of fotoTicket.files) ticket.push(await fileToJpegDataURL(f));
  }
  if (fotoMaterial?.files?.length) {
    for (const f of fotoMaterial.files) material.push(await fileToJpegDataURL(f));
  }

  return { ticket, material };
}

// Dibuja texto con estilo ‚Äúparte‚Äù
// (PDF: A4, unidades mm)
function addHeader(doc, meta) {
  const M = 14;
  let y = 16;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("PARTE ¬∑ INSTALACI√ìN", M, y);

  y += 8;
  doc.setDrawColor(30);
  doc.setLineWidth(0.3);
  doc.line(M, y, 210 - M, y);
  y += 8;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(`Fecha: ${meta.fecha}`, M, y); y += 6;
  doc.text(`ID Cliente: ${meta.idCliente}`, M, y); y += 6;
  doc.text(`T√©cnicos: ${meta.tecnicos}`, M, y); y += 6;

  return y + 2;
}

function addTable(doc, startY, rows) {
  const M = 14;
  const W = 210 - M * 2;
  const col1 = M;
  const col2 = M + 95;
  const col3 = M + 140;

  let y = startY;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("DETALLE", M, y);
  y += 6;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);

  // Encabezado
  doc.setDrawColor(220);
  doc.setLineWidth(0.3);
  doc.line(M, y, M + W, y);
  y += 6;

  for (const r of rows) {
    // salto p√°gina si hace falta
    if (y > 270) {
      doc.addPage();
      y = 16;
    }
    doc.text(r.label, col1, y);
    doc.text(r.qty, col2, y, { align: "right" });
    doc.text(r.amount, col3, y, { align: "right" });
    y += 6;
  }

  doc.setDrawColor(220);
  doc.line(M, y, M + W, y);
  y += 10;

  return y;
}

function addTotal(doc, y, totalStr) {
  const M = 14;
  const W = 210 - M * 2;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("TOTAL", M, y);
  doc.text(totalStr, M + W, y, { align: "right" });
  return y + 10;
}

function addObservaciones(doc, y, obs) {
  const M = 14;
  const W = 210 - M * 2;

  if (y > 255) {
    doc.addPage();
    y = 16;
  }

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("OBSERVACIONES", M, y);
  y += 6;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);

  const text = obs?.trim() ? obs.trim() : "‚Äî";
  const lines = doc.splitTextToSize(text, W);
  doc.text(lines, M, y);

  return y + (lines.length * 5) + 6;
}

// A√±ade fotos como ‚Äúgrid‚Äù con t√≠tulo por secci√≥n
async function addPhotos(doc, y, title, images) {
  const M = 14;
  const W = 210 - M * 2;

  if (!images.length) return y;

  if (y > 240) {
    doc.addPage();
    y = 16;
  }

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text(title, M, y);
  y += 8;

  // Grid 2 columnas
  const gap = 6;
  const cellW = (W - gap) / 2;
  const cellH = 60;

  let x = M;
  let col = 0;

  for (let i = 0; i < images.length; i++) {
    if (y + cellH > 285) {
      doc.addPage();
      y = 16;
      x = M;
      col = 0;
    }

    // Nota: jsPDF detecta PNG/JPEG si le pasas dataURL
    doc.setDrawColor(220);
    doc.rect(x, y, cellW, cellH);

    // Imagen dentro
    const img = images[i];
const format = img.startsWith("data:image/png") ? "PNG" : "JPEG";
doc.addImage(img, "JPEG", x + 2, y + 2, cellW - 4, cellH - 4);

    col++;
    if (col === 2) {
      col = 0;
      x = M;
      y += (cellH + gap);
    } else {
      x = M + cellW + gap;
    }
  }

  return y + 6;
}

btnPDF.addEventListener("click", async () => {
  err.textContent = "";
  ok.textContent = "";

  if (!header.idCliente) {
    err.textContent = "Falta ID Cliente (vuelve atr√°s y cr√©alo desde Nuevo Parte).";
    return;
  }

  try {
    // Datos
    const hi = clamp0(toNum(hInst.value));
    const hd = clamp0(toNum(hDespl.value));
    const km = clamp0(toNum(kms.value));
    const co = clamp0(toNum(comida.value));
    const ma = clamp0(toNum(material.value));
    const fu = furgonOn.checked ? FURGON : 0;

    const impInst = hi * P_INST * TECNICOS_INST;
    const impDespl = hd * P_DESPL;
    const impKm = km * P_KM;
    const total = impInst + impDespl + impKm + co + ma + fu;

    const obs = document.getElementById("obs").value || "";

    // Fotos
    const { ticket, material } = await collectImages();

    // PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4" });

    let y = addHeader(doc, {
      fecha: header.fecha || "‚Äî",
      idCliente: header.idCliente || "‚Äî",
      tecnicos: TECNICOS_INST
    });

    const rows = [
      { label: "Horas instalaci√≥n", qty: `${hi.toFixed(1).replace(".", ",")} h`, amount: EUR(impInst) },
      { label: "Horas despl.",      qty: `${hd.toFixed(1).replace(".", ",")} h`, amount: EUR(impDespl) },
      { label: "Kil√≥metros",        qty: `${String(km).replace(".", ",")}`,      amount: EUR(impKm) },
      { label: "Comida",            qty: "",                                     amount: EUR(co) },
      { label: "Material",          qty: "",                                     amount: EUR(ma) },
      { label: "Furg√≥n",            qty: furgonOn.checked ? "S√≠" : "No",         amount: EUR(fu) },
    ];

    y = addTable(doc, y, rows);
    y = addTotal(doc, y, EUR(total));
    y = addObservaciones(doc, y, obs);

    // Fotos (si las hay)
    y = await addPhotos(doc, y, `FOTOS ¬∑ Ticket comida (${ticket.length})`, ticket);
    y = await addPhotos(doc, y, `FOTOS ¬∑ Material (${material.length})`, material);

    const pdfBlob = doc.output("blob");
    const filename = `Parte_Instalacion_${header.idCliente || "cliente"}_${header.fecha || "fecha"}.pdf`;
    const file = new File([pdfBlob], filename, { type: "application/pdf" });

    // Compartir como archivo (iOS share sheet -> WhatsApp)
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        files: [file],
        title: "Parte de instalaci√≥n",
        text: "Adjunto parte en PDF."
      });
      ok.textContent = "PDF compartido ‚úÖ";
      return;
    }

    // Fallback: descargar
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    ok.textContent = "PDF descargado (fallback) ‚úÖ";

} catch (e) {
  console.error(e);
  err.textContent = "PDF ERROR: " + (e?.message ? e.message : String(e));
}
});
  </script>

  <style>
    /* Peque√±as extensiones espec√≠ficas sin tocar styles.css por ahora */
    .back{
      position:absolute;
      left:16px;
      top:16px;
      text-decoration:none;
      font-size:22px;
      font-weight:900;
      color:var(--primary);
    }
    .topbar{ position:sticky; }
    .topbar h1{ text-align:center; }

    .meta{ display:grid; gap:8px; font-size:16px; }
    .rowhead{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .rate{ font-weight:900; color:var(--muted); }

    .field.onecol{ grid-template-columns: 1fr; grid-template-rows:auto; }
    .quick{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .q{
      height:44px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:18px;
      font-weight:900;
      color:var(--primary);
    }

    .totline{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:12px; margin-top:8px;
      border-top:1px solid var(--line);
      font-size:16px;
      color:var(--muted);
    }
    .totline strong{ color:var(--text); font-size:18px; }

    .attach{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-top:10px;
    }
    .btn-attach{
      display:inline-flex; align-items:center; justify-content:center;
      height:52px;
      padding:0 14px;
      border-radius:14px;
      background:#0b5cff;
      color:#fff;
      font-weight:900;
      border:none;
      cursor:pointer;
      user-select:none;
    }
    .btn-attach input{ display:none; }
    .count{ color:var(--muted); font-weight:800; }

    .switchrow{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
    }
    .switch{ position:relative; width:56px; height:34px; display:inline-block; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background:#cbd5e1;
      border-radius:999px;
      transition:.2s;
    }
    .slider:before{
      content:"";
      position:absolute; width:28px; height:28px;
      left:3px; top:3px;
      background:#fff;
      border-radius:999px;
      transition:.2s;
      box-shadow:0 8px 18px rgba(2,8,23,.15);
    }
    .switch input:checked + .slider{ background: rgba(11,92,255,.85); }
    .switch input:checked + .slider:before{ transform: translateX(22px); }
    .swtitle{ font-weight:900; }
    .swsub{ color:var(--muted); font-weight:700; font-size:13px; }

    textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      font-size:18px;
      font-family:var(--font);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(11,92,255,.45);
      box-shadow: 0 0 0 4px rgba(11,92,255,.12);
    }

    .sumline{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 0;
      border-bottom:1px dashed var(--line);
      color:var(--muted);
      font-weight:800;
    }
    .sumline strong{ color:var(--text); }
    .sumtotal{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:14px;
      font-size:22px;
      font-weight:1000;
    }
    .msg.ok{ color:#15803d; }
    .stepper{
  display:grid;
  grid-template-columns: 1fr 1.2fr 1fr;
  gap:10px;
  align-items:center;
  margin-top:6px;
}

.step{
  height:56px;
  border-radius:16px;
  border:1px solid var(--line);
  background:#fff;
  font-size:18px;
  font-weight:1000;
  color:var(--primary);
}

.stepval{
  height:56px;
  border-radius:16px;
  border:1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:1000;
  background:#fff;
}

.quick .qdelta,
.quick .qreset{
  height:44px;
  padding:0 14px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  font-size:18px;
  font-weight:1000;
  color:var(--primary);
}
    .btn-attach.alt{
  background:#ffffff;
  color:var(--primary);
  border:1px solid rgba(11,92,255,.35);
}

.camModal{
  position:fixed;
  inset:0;
  background:rgba(2,8,23,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:9999;
}

.camPanel{
  width:min(720px, 100%);
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  border:1px solid var(--line);
  box-shadow: 0 18px 50px rgba(2,8,23,.25);
}

.camTop{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 14px;
  border-bottom:1px solid var(--line);
}

.camClose{
  border:none;
  background:transparent;
  font-size:20px;
  font-weight:900;
  color:var(--primary);
}

#camVideo{
  width:100%;
  height:55vh;
  background:#000;
  object-fit:cover;
}

.camBottom{
  display:flex;
  gap:10px;
  padding:12px 14px;
  border-top:1px solid var(--line);
}

.camBtnPrimary{
  flex:1.4;
  height:54px;
  border-radius:14px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:1000;
  font-size:18px;
}

.camBtn{
  flex:1;
  height:54px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  color:var(--primary);
  font-weight:1000;
  font-size:16px;
}

.camBtn:disabled,
.camBtnPrimary:disabled{
  opacity:.45;
}

.camMsg{
  margin:0;
  padding:0 14px 14px;
  color:#b91c1c;
  font-weight:800;
  min-height:20px;
}
    /* FIX: que el atributo hidden funcione aunque .camModal tenga display:flex */
.camModal[hidden] { 
  display: none !important; 
}
    .btnRow{
  display:grid;
  gap:10px;
}

.btn-secondary{
  width:100%;
  height:64px;
  border-radius:18px;
  border:1px solid rgba(11,92,255,.35);
  background:#fff;
  color:var(--primary);
  font-size:20px;
  font-weight:1000;
}
  </style>
</body>
</html>
