<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Instalaci√≥n ¬∑ Postventa Canarias</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b5cff">
  <link rel="stylesheet" href="./styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="topbar">
<a class="back" href="./nuevo-parte.html" aria-label="Volver">‚Üê</a>
    <h1>Instalaci√≥n</h1>
  </header>

  <main class="container">
    <!-- Cabecera -->
    <section class="card">
      <div class="meta">
        <div><strong>Intervenci√≥n:</strong> Instalaci√≥n</div>
        <div><strong>Fecha:</strong> <span id="mFecha">‚Äî</span></div>
        <div><strong>ID Cliente:</strong> <span id="mId">‚Äî</span></div>
        <div><strong>T√©cnicos:</strong> 2</div>
      </div>

      <!-- T√©cnicos -->
      <div class="field onecol" style="margin-top:12px;">
        <label style="font-weight:900; display:block; margin-bottom:6px;">T√©cnico 1</label>
        <select id="tec1" style="width:100%; height:56px; border-radius:14px; border:1px solid var(--line); font-size:18px; padding:0 12px;">
          <option value="" selected>Selecciona‚Ä¶</option>
          <option value="JUAN PABLO CABRERA PEREZ">JUAN PABLO CABRERA PEREZ</option>
          <option value="DAMASO ROLDAN PEREZ">DAMASO ROLDAN PEREZ</option>
          <option value="PABLO ECHEDEY ESPINO ORTEGA">PABLO ECHEDEY ESPINO ORTEGA</option>
          <option value="YISHAR ROMAN MEDINA">YISHAR ROMAN MEDINA</option>
        </select>
      </div>

      <div class="field onecol" style="margin-top:10px;">
        <label style="font-weight:900; display:block; margin-bottom:6px;">T√©cnico 2</label>
        <select id="tec2" style="width:100%; height:56px; border-radius:14px; border:1px solid var(--line); font-size:18px; padding:0 12px;">
          <option value="" selected>Selecciona‚Ä¶</option>
          <option value="JUAN PABLO CABRERA PEREZ">JUAN PABLO CABRERA PEREZ</option>
          <option value="DAMASO ROLDAN PEREZ">DAMASO ROLDAN PEREZ</option>
          <option value="PABLO ECHEDEY ESPINO ORTEGA">PABLO ECHEDEY ESPINO ORTEGA</option>
          <option value="YISHAR ROMAN MEDINA">YISHAR ROMAN MEDINA</option>
        </select>
      </div>
    </section>

    <!-- Horas instalaci√≥n -->
    <section class="card">
      <div class="rowhead">
        <h2>Horas de instalaci√≥n</h2>
        <div class="rate">27,95 ‚Ç¨/h √ó2 t√©cnicos</div>
      </div>

      <div class="stepper">
        <button type="button" class="step" data-target="hInst" data-delta="-0.5">‚àí0,5</button>
        <div class="stepval"><span id="hInstText">0,0</span> h</div>
        <button type="button" class="step" data-target="hInst" data-delta="0.5">+0,5</button>
      </div>

      <div class="quick">
        <button class="qdelta" type="button" data-target="hInst" data-delta="1">+1</button>
        <button class="qdelta" type="button" data-target="hInst" data-delta="2">+2</button>
        <button class="qdelta" type="button" data-target="hInst" data-delta="4">+4</button>
        <button class="qdelta" type="button" data-target="hInst" data-delta="8">+8</button>
        <button class="qreset" type="button" data-target="hInst">Reset</button>
      </div>

      <input id="hInst" type="hidden" value="0" />

      <div class="totline">
        <span>Total instalaci√≥n</span>
        <strong id="tInst">0,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Horas desplazamiento -->
    <section class="card">
      <div class="rowhead">
        <h2>Horas de desplazamiento</h2>
        <div class="rate">19,28 ‚Ç¨/h √ó2 t√©cnicos</div>
      </div>

      <div class="stepper">
        <button type="button" class="step" data-target="hDespl" data-delta="-0.5">‚àí0,5</button>
        <div class="stepval">
          <span id="hDesplText">0,0</span> h
        </div>
        <button type="button" class="step" data-target="hDespl" data-delta="0.5">+0,5</button>
      </div>

      <div class="quick">
        <button class="qdelta" type="button" data-target="hDespl" data-delta="1">+1</button>
        <button class="qdelta" type="button" data-target="hDespl" data-delta="2">+2</button>
        <button class="qdelta" type="button" data-target="hDespl" data-delta="4">+4</button>
        <button class="qdelta" type="button" data-target="hDespl" data-delta="8">+8</button>
        <button class="qreset" type="button" data-target="hDespl">Reset</button>
      </div>

      <input id="hDespl" type="hidden" value="0" />

      <div class="totline">
        <span>Total desplazamiento</span>
        <strong id="tDespl">0,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Kil√≥metros -->
    <section class="card">
      <div class="rowhead">
        <h2>Kil√≥metros</h2>
        <div class="rate">0,31 ‚Ç¨/km</div>
      </div>

      <label class="field onecol">
        <input id="kms" inputmode="numeric" pattern="[0-9]*" placeholder="0" />
      </label>

      <div class="totline">
        <span>Total km</span>
        <strong id="tKm">0,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Comida -->
    <section class="card">
      <div class="rowhead">
        <h2>Comida</h2>
        <div class="rate">‚Ç¨</div>
      </div>

      <label class="field onecol">
        <input id="comida" inputmode="decimal" placeholder="0" />
      </label>

      <div class="attach">
        <button type="button" class="btn-attach" id="btnCamTicket">üì∑ Sacar foto</button>

        <label class="btn-attach alt">
          üñºÔ∏è Fototeca
          <input id="fotoTicket" type="file" accept="image/*" />
        </label>

        <button type="button" class="btn-trash" id="btnDelTicket" title="Borrar foto ticket">üóëÔ∏è</button>
        <span class="count" id="cTicket">0 fotos</span>
      </div>
    </section>

    <!-- Material -->
    <section class="card">
      <div class="rowhead">
        <h2>Consumibles / Material</h2>
        <div class="rate">‚Ç¨</div>
      </div>

      <label class="field onecol">
        <input id="material" inputmode="decimal" placeholder="0" />
      </label>

      <div class="attach">
        <button type="button" class="btn-attach" id="btnCamMaterial">üì∑ Sacar foto</button>

        <label class="btn-attach alt">
          üñºÔ∏è Fototeca
          <input id="fotoMaterial" type="file" accept="image/*" />
        </label>

        <button type="button" class="btn-trash" id="btnDelMaterial" title="Borrar foto material">üóëÔ∏è</button>
        <span class="count" id="cMat">0 fotos</span>
      </div>
    </section>

    <!-- Furg√≥n -->
    <section class="card">
      <div class="rowhead">
        <h2>Furg√≥n</h2>
        <div class="rate">80,00 ‚Ç¨</div>
      </div>

      <div class="switchrow">
        <label class="switch">
          <input id="furgonOn" type="checkbox" checked />
          <span class="slider"></span>
        </label>
        <div class="swtext">
          <div class="swtitle">Aplicar furg√≥n</div>
          <div class="swsub">Por defecto activo</div>
        </div>
        <strong id="tFurgon">80,00 ‚Ç¨</strong>
      </div>
    </section>

    <!-- Observaciones -->
    <section class="card">
      <h2>Observaciones</h2>
      <textarea id="obs" rows="4" placeholder="Escribe aqu√≠ si hay algo que anotar..."></textarea>
    </section>

    <!-- Resumen -->
    <section class="card">
      <h2>Resumen</h2>

      <div class="sumline"><span>Instalaci√≥n</span><strong id="sInst">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Desplazamiento</span><strong id="sDespl">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Kil√≥metros</span><strong id="sKm">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Comida</span><strong id="sComida">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Material</span><strong id="sMat">0,00 ‚Ç¨</strong></div>
      <div class="sumline"><span>Furg√≥n</span><strong id="sFurgon">80,00 ‚Ç¨</strong></div>

      <div class="sumtotal">
        <span>TOTAL</span>
        <strong id="total">80,00 ‚Ç¨</strong>
      </div>
    </section>

    <section class="card">
<div class="btnRow">
  <button id="btnGuardar" class="btn-primary" type="button">GUARDAR</button>
</div>

      <p class="msg ok" id="ok" aria-live="polite"></p>
      <p class="msg" id="err" aria-live="polite"></p>
    </section>

    <!-- MODAL C√ÅMARA -->
    <div id="camModal" class="camModal" hidden>
      <div class="camPanel">
        <div class="camTop">
          <strong id="camTitle">C√°mara</strong>
          <button type="button" id="camClose" class="camClose">‚úï</button>
        </div>

        <video id="camVideo" playsinline autoplay></video>
        <canvas id="camCanvas" hidden></canvas>

        <div class="camBottom">
          <button type="button" id="camShot" class="camBtnPrimary">CAPTURAR</button>
          <button type="button" id="camUse" class="camBtn" disabled>USAR FOTO</button>
          <button type="button" id="camRetake" class="camBtn" disabled>REPETIR</button>
        </div>

        <p id="camMsg" class="camMsg"></p>
      </div>
    </div>
  </main>

  <script>
    // ------- Utilidades -------
    const EUR = (n) => new Intl.NumberFormat("es-ES", { style:"currency", currency:"EUR" }).format(n);

    const toNum = (v) => {
      if (!v) return 0;
      const s = String(v).trim().replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    };

    const clamp0 = (n) => (n < 0 ? 0 : n);

    // Tarifas
    const P_INST = 27.95;
    const P_DESPL = 19.28;
    const P_KM = 0.31;
    const FURGON = 80.00;
    const TECNICOS_INST = 2;

    // Fotos: l√≠mite por campo
    const MAX_TICKET = 1;
    const MAX_MATERIAL = 1;

    // ------- Cargar cabecera -------
    const header = (() => {
      try { return JSON.parse(localStorage.getItem("pv_header") || "{}"); }
      catch { return {}; }
    })();

    document.getElementById("mFecha").textContent = header.fecha || "‚Äî";
    document.getElementById("mId").textContent = header.idCliente || "‚Äî";

    // ------- T√©cnicos (2 selectores) -------
    const tec1 = document.getElementById("tec1");
    const tec2 = document.getElementById("tec2");

    try {
      const last = JSON.parse(localStorage.getItem("pv_tecnicos_inst") || "{}");
      tec1.value = last.tec1 || "";
      tec2.value = last.tec2 || "";
    } catch {}

    const saveTechs = () => {
      localStorage.setItem("pv_tecnicos_inst", JSON.stringify({
        tec1: tec1.value || "",
        tec2: tec2.value || ""
      }));
    };

    const syncTechOptions = () => {
      const v1 = tec1.value || "";
      const v2 = tec2.value || "";

      [...tec1.options].forEach(opt => {
        if (!opt.value) return;
        opt.disabled = (opt.value === v2);
      });
      [...tec2.options].forEach(opt => {
        if (!opt.value) return;
        opt.disabled = (opt.value === v1);
      });
    };

    tec1.addEventListener("change", () => { saveTechs(); syncTechOptions(); });
    tec2.addEventListener("change", () => { saveTechs(); syncTechOptions(); });
    syncTechOptions();

    // ------- Inputs -------
    const hInst = document.getElementById("hInst");
    const hDespl = document.getElementById("hDespl");
    const kms = document.getElementById("kms");
    const comida = document.getElementById("comida");
    const material = document.getElementById("material");
    const furgonOn = document.getElementById("furgonOn");

    const fotoTicket = document.getElementById("fotoTicket");
    const fotoMaterial = document.getElementById("fotoMaterial");
    const cTicket = document.getElementById("cTicket");
    const cMat = document.getElementById("cMat");

    const btnDelTicket = document.getElementById("btnDelTicket");
    const btnDelMaterial = document.getElementById("btnDelMaterial");

    // Mensajes
    const ok = document.getElementById("ok");
    const err = document.getElementById("err");

    // ------- C√°lculos -------
    const tInst = document.getElementById("tInst");
    const tDespl = document.getElementById("tDespl");
    const tKm = document.getElementById("tKm");
    const tFurgon = document.getElementById("tFurgon");

    const sInst = document.getElementById("sInst");
    const sDespl = document.getElementById("sDespl");
    const sKm = document.getElementById("sKm");
    const sComida = document.getElementById("sComida");
    const sMat = document.getElementById("sMat");
    const sFurgon = document.getElementById("sFurgon");
    const totalEl = document.getElementById("total");

    const recalc = () => {
      const hi = clamp0(toNum(hInst.value));
      const hd = clamp0(toNum(hDespl.value));
      const km = clamp0(toNum(kms.value));
      const co = clamp0(toNum(comida.value));
      const ma = clamp0(toNum(material.value));
      const fu = furgonOn.checked ? FURGON : 0;

      const a = hi * P_INST * TECNICOS_INST;        // instalaci√≥n √ó2
      const b = hd * P_DESPL * TECNICOS_INST;       // desplazamiento √ó2
      const c = km * P_KM;                          // km NO √ó2

      tInst.textContent = EUR(a);
      tDespl.textContent = EUR(b);
      tKm.textContent = EUR(c);

      const tf = EUR(fu);
      tFurgon.textContent = tf;

      sInst.textContent = EUR(a);
      sDespl.textContent = EUR(b);
      sKm.textContent = EUR(c);
      sComida.textContent = EUR(co);
      sMat.textContent = EUR(ma);
      sFurgon.textContent = tf;

      const tot = a + b + c + co + ma + fu;
      totalEl.textContent = EUR(tot);
    };

    ["input","change"].forEach(evt => {
      hInst.addEventListener(evt, recalc);
      hDespl.addEventListener(evt, recalc);
      kms.addEventListener(evt, recalc);
      comida.addEventListener(evt, recalc);
      material.addEventListener(evt, recalc);
      furgonOn.addEventListener(evt, recalc);
    });

    // --- STEPPER horas (saltos de 0,5 hasta 30h) ---
    const setHalfHour = (val) => {
      let v = Math.round(val * 2) / 2;
      if (v < 0) v = 0;
      if (v > 30) v = 30;
      return v;
    };

    const fmtHours = (v) => String(v.toFixed(1)).replace(".", ",");

    const syncDisplays = () => {
      const hi = toNum(hInst.value || 0);
      const hd = toNum(hDespl.value || 0);
      const ti = document.getElementById("hInstText");
      const td = document.getElementById("hDesplText");
      if (ti) ti.textContent = fmtHours(hi);
      if (td) td.textContent = fmtHours(hd);
    };

    document.querySelectorAll(".step").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        const delta = Number(btn.dataset.delta);
        const el = document.getElementById(target);
        const cur = toNum(el.value || 0);
        el.value = setHalfHour(cur + delta);
        syncDisplays();
        recalc();
      });
    });

    document.querySelectorAll(".qdelta").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        const delta = Number(btn.dataset.delta);
        const el = document.getElementById(target);
        const cur = toNum(el.value || 0);
        el.value = setHalfHour(cur + delta);
        syncDisplays();
        recalc();
      });
    });

    document.querySelectorAll(".qreset").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.target;
        const el = document.getElementById(target);
        el.value = 0;
        syncDisplays();
        recalc();
      });
    });

    // -------- Fotos (c√°mara propia + fototeca) --------
    let ticketShots = [];
    let materialShots = [];

    const getTicketCount = () => (ticketShots.length + (fotoTicket.files?.length || 0));
    const getMaterialCount = () => (materialShots.length + (fotoMaterial.files?.length || 0));

    const updatePhotoCounts = () => {
      cTicket.textContent = `${getTicketCount()} foto`;
      cMat.textContent = `${getMaterialCount()} foto`;
    };

    const enforceSingleFile = (inputEl) => {
      if (!inputEl?.files) return;
      if (inputEl.files.length <= 1) return;
      const dt = new DataTransfer();
      dt.items.add(inputEl.files[0]);
      inputEl.files = dt.files;
    };

    const clearTicketPhoto = () => {
      ticketShots = [];
      fotoTicket.value = "";
      updatePhotoCounts();
    };

    const clearMaterialPhoto = () => {
      materialShots = [];
      fotoMaterial.value = "";
      updatePhotoCounts();
    };

    btnDelTicket.addEventListener("click", () => { err.textContent = ""; ok.textContent=""; clearTicketPhoto(); });
    btnDelMaterial.addEventListener("click", () => { err.textContent = ""; ok.textContent=""; clearMaterialPhoto(); });

    // Fototeca: 1 m√°ximo y si ya hay foto -> no deja
    fotoTicket.addEventListener("change", () => {
      enforceSingleFile(fotoTicket);

      if (ticketShots.length >= MAX_TICKET) {
        err.textContent = "Solo 1 foto de Ticket por parte. Borra la anterior (üóëÔ∏è) para cambiarla.";
        fotoTicket.value = "";
        return;
      }
      err.textContent = "";
      updatePhotoCounts();
    });

    fotoMaterial.addEventListener("change", () => {
      enforceSingleFile(fotoMaterial);

      if (materialShots.length >= MAX_MATERIAL) {
        err.textContent = "Solo 1 foto de Material por parte. Borra la anterior (üóëÔ∏è) para cambiarla.";
        fotoMaterial.value = "";
        return;
      }
      err.textContent = "";
      updatePhotoCounts();
    });

    // -------- C√°mara propia --------
    const camModal = document.getElementById("camModal");
    camModal.hidden = true;
    const camVideo = document.getElementById("camVideo");
    const camCanvas = document.getElementById("camCanvas");
    const camShot = document.getElementById("camShot");
    const camUse = document.getElementById("camUse");
    const camRetake = document.getElementById("camRetake");
    const camClose = document.getElementById("camClose");
    const camMsg = document.getElementById("camMsg");
    const camTitle = document.getElementById("camTitle");

    const btnCamTicket = document.getElementById("btnCamTicket");
    const btnCamMaterial = document.getElementById("btnCamMaterial");

    let currentTarget = null;
    let stream = null;
    let lastDataUrl = null;

    const openCam = async (target) => {
      // Bloqueo por l√≠mite 1
      if (target === "ticket" && getTicketCount() >= MAX_TICKET) {
        err.textContent = "Ya hay 1 foto de Ticket. Borra la anterior (üóëÔ∏è) para cambiarla.";
        return;
      }
      if (target === "material" && getMaterialCount() >= MAX_MATERIAL) {
        err.textContent = "Ya hay 1 foto de Material. Borra la anterior (üóëÔ∏è) para cambiarla.";
        return;
      }

      err.textContent = "";
      currentTarget = target;
      lastDataUrl = null;
      camMsg.textContent = "";
      camUse.disabled = true;
      camRetake.disabled = true;
      camShot.disabled = false;

      camTitle.textContent = target === "ticket" ? "C√°mara ¬∑ Ticket" : "C√°mara ¬∑ Material";
      camModal.hidden = false;

      try {
        const constraints = { video: { facingMode: { ideal: "environment" } }, audio: false };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        camVideo.srcObject = stream;
        await camVideo.play();
      } catch (e) {
        camMsg.textContent = "No se pudo abrir la c√°mara. Usa Fototeca si hace falta.";
        closeCam();
      }
    };

    const closeCam = () => {
      camModal.hidden = true;
      camMsg.textContent = "";
      lastDataUrl = null;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      camVideo.srcObject = null;
    };

    camClose.addEventListener("click", closeCam);

    camShot.addEventListener("click", () => {
      if (!camVideo.videoWidth || !camVideo.videoHeight) {
        camMsg.textContent = "La c√°mara a√∫n no est√° lista. Espera 1 segundo y prueba otra vez.";
        return;
      }

      const w = camVideo.videoWidth;
      const h = camVideo.videoHeight;

      camCanvas.width = w;
      camCanvas.height = h;
      const ctx = camCanvas.getContext("2d");
      ctx.drawImage(camVideo, 0, 0, w, h);

      lastDataUrl = camCanvas.toDataURL("image/jpeg", 0.85);

      camUse.disabled = false;
      camRetake.disabled = false;
      camShot.disabled = true;
      camMsg.textContent = "Foto capturada ‚úÖ";
    });

    camUse.addEventListener("click", () => {
      if (!lastDataUrl) return;

      // Fuerza 1 m√°ximo (y respeta el l√≠mite total)
      if (currentTarget === "ticket") {
        if (getTicketCount() >= MAX_TICKET) {
          camMsg.textContent = "Ya hay 1 foto de Ticket. Borra la anterior (üóëÔ∏è) para cambiarla.";
          return;
        }
        ticketShots = [lastDataUrl];
      }

      if (currentTarget === "material") {
        if (getMaterialCount() >= MAX_MATERIAL) {
          camMsg.textContent = "Ya hay 1 foto de Material. Borra la anterior (üóëÔ∏è) para cambiarla.";
          return;
        }
        materialShots = [lastDataUrl];
      }

      updatePhotoCounts();
      closeCam();
    });

    camRetake.addEventListener("click", () => {
      lastDataUrl = null;
      camUse.disabled = true;
      camRetake.disabled = true;
      camShot.disabled = false;
      camMsg.textContent = "";
    });

    btnCamTicket.addEventListener("click", () => openCam("ticket"));
    btnCamMaterial.addEventListener("click", () => openCam("material"));

    // ------- Helpers imagen -> JPEG DataURL (persistir en local/PDF) -------
    const fileToDataURL = (file) => new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });

    const dataUrlToJpeg = (src) => new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        const MAX_W = 1400;
        let w = img.naturalWidth || img.width;
        let h = img.naturalHeight || img.height;
        if (w > MAX_W) { h = Math.round(h * (MAX_W / w)); w = MAX_W; }

        const c = document.createElement("canvas");
        c.width = w; c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL("image/jpeg", 0.85));
      };
      img.onerror = reject;
      img.src = src;
    });

    const fileToJpegDataURL = async (file) => dataUrlToJpeg(await fileToDataURL(file));

    const collectFototecaJpegs = async (inputEl) => {
      const out = [];
      const files = inputEl?.files ? Array.from(inputEl.files) : [];
      for (const f of files) {
        try { out.push(await fileToJpegDataURL(f)); } catch(_) {}
      }
      return out;
    };

    // ------- Guardado local -------
    const btnGuardar = document.getElementById("btnGuardar");

    btnGuardar.addEventListener("click", async () => {
      ok.textContent = "";
      err.textContent = "";

      if (!header.idCliente) {
        err.textContent = "Falta ID Cliente (vuelve atr√°s y cr√©alo desde Nuevo Parte).";
        return;
      }
      if (!tec1.value || !tec2.value) {
        err.textContent = "Selecciona T√©cnico 1 y T√©cnico 2.";
        return;
      }
      if (tec1.value === tec2.value) {
        err.textContent = "T√©cnico 1 y T√©cnico 2 no pueden ser el mismo.";
        return;
      }

      // Normaliza y guarda 1 foto m√°ximo por campo (c√°mara + fototeca)
      const ticketFototeca = await collectFototecaJpegs(fotoTicket);
      const materialFototeca = await collectFototecaJpegs(fotoMaterial);

      const ticketAll = [...ticketShots, ...ticketFototeca].slice(0, 1);
      const materialAll = [...materialShots, ...materialFototeca].slice(0, 1);

      const hi = clamp0(toNum(hInst.value));
const hd = clamp0(toNum(hDespl.value));
const km = clamp0(toNum(kms.value));
const co = clamp0(toNum(comida.value));
const ma = clamp0(toNum(material.value));
const fu = furgonOn.checked ? FURGON : 0;

const a = hi * P_INST * TECNICOS_INST;
const b = hd * P_DESPL * TECNICOS_INST;
const c = km * P_KM;
const tot = a + b + c + co + ma + fu;

const savedAt = new Date().toISOString();
const partId = `${header?.fecha || "nodate"}::${header?.idCliente || "noclient"}::instalacion::${savedAt}`;

const payload = {
        part_id: partId,
        sent_by: {},
        header: { ...header, tecnico1: tec1.value || "", tecnico2: tec2.value || "" },
        tipo: "instalacion",
        tarifas: { P_INST, P_DESPL, P_KM, FURGON },
        datos: {
          horas_inst: toNum(hInst.value),
          horas_despl: toNum(hDespl.value),
          kms: toNum(kms.value),
          comida: toNum(comida.value),
          material: toNum(material.value),
          furgon: furgonOn.checked
        },
        totales: { total: tot },
        observaciones: document.getElementById("obs").value || "",
        fotos: {
          ticket_count: ticketAll.length,
          material_count: materialAll.length,
          ticket_dataurls: ticketAll,
          material_dataurls: materialAll
        },
        saved_at: savedAt
      };

      const key = "pv_partes";
      let arr = [];
      try { arr = JSON.parse(localStorage.getItem(key) || "[]"); } catch {}
      try {
arr.push(payload);
localStorage.setItem(key, JSON.stringify(arr));

// ‚úÖ TRUCO iOS: deja respirar el event loop para que localStorage se escriba antes de navegar
ok.textContent = "Guardado en el m√≥vil ‚úÖ";
await new Promise(r => requestAnimationFrame(r));
await new Promise(r => setTimeout(r, 50));

window.location.href = "./index.html";

  // Volver autom√°ticamente al selector
  setTimeout(() => {
    window.location.href = "./index.html";
  }, 400);

} catch (e) {
  console.error(e);
  err.textContent = "Error guardando en el tel√©fono.";
  return;
}
    });
    
    // Inicializaci√≥n final
    syncDisplays();
    recalc();
    updatePhotoCounts();
  </script>

  <style>
    /* Peque√±as extensiones espec√≠ficas sin tocar styles.css por ahora */

    .meta{ display:grid; gap:8px; font-size:16px; }
    .rowhead{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .rate{ font-weight:900; color:var(--muted); }

    .field.onecol{ grid-template-columns: 1fr; grid-template-rows:auto; }

    .quick{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }

    .totline{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:12px; margin-top:8px;
      border-top:1px solid var(--line);
      font-size:16px;
      color:var(--muted);
    }
    .totline strong{ color:var(--text); font-size:18px; }

    .attach{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top:10px;
    }
    .btn-attach{
      display:inline-flex; align-items:center; justify-content:center;
      height:52px;
      padding:0 14px;
      border-radius:14px;
      background:#0b5cff;
      color:#fff;
      font-weight:900;
      border:none;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .btn-attach input{ display:none; }

    .btn-attach.alt{
      background:#ffffff;
      color:var(--primary);
      border:1px solid rgba(11,92,255,.35);
    }

    .btn-trash{
      height:52px;
      width:52px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.6);
      background:#fff;
      font-size:18px;
      font-weight:900;
      color:#0f172a;
      cursor:pointer;
      flex:0 0 auto;
    }
    .btn-trash:active{ transform: translateY(1px); }

    .count{ color:var(--muted); font-weight:800; min-width:64px; text-align:right; }

    .switchrow{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
    }
    .switch{ position:relative; width:56px; height:34px; display:inline-block; }
    .switch input{ display:none; }
    .slider{
      position:absolute; inset:0;
      background:#cbd5e1;
      border-radius:999px;
      transition:.2s;
    }
    .slider:before{
      content:"";
      position:absolute; width:28px; height:28px;
      left:3px; top:3px;
      background:#fff;
      border-radius:999px;
      transition:.2s;
      box-shadow:0 8px 18px rgba(2,8,23,.15);
    }
    .switch input:checked + .slider{ background: rgba(11,92,255,.85); }
    .switch input:checked + .slider:before{ transform: translateX(22px); }
    .swtitle{ font-weight:900; }
    .swsub{ color:var(--muted); font-weight:700; font-size:13px; }

    textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      font-size:18px;
      font-family:var(--font);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(11,92,255,.45);
      box-shadow: 0 0 0 4px rgba(11,92,255,.12);
    }

    .sumline{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 0;
      border-bottom:1px dashed var(--line);
      color:var(--muted);
      font-weight:800;
    }
    .sumline strong{ color:var(--text); }
    .sumtotal{
      display:flex; justify-content:space-between; align-items:center;
      padding-top:14px;
      font-size:22px;
      font-weight:1000;
    }
    .msg.ok{ color:#15803d; }

    .stepper{
      display:grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap:10px;
      align-items:center;
      margin-top:6px;
    }

    .step{
      height:56px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      font-size:18px;
      font-weight:1000;
      color:var(--primary);
    }

    .stepval{
      height:56px;
      border-radius:16px;
      border:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:1000;
      background:#fff;
    }

    .quick .qdelta,
    .quick .qreset{
      height:44px;
      padding:0 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      font-size:18px;
      font-weight:1000;
      color:var(--primary);
    }

    .camModal{
      position:fixed;
      inset:0;
      background:rgba(2,8,23,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }

    .camPanel{
      width:min(720px, 100%);
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: 0 18px 50px rgba(2,8,23,.25);
    }

    .camTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
    }

    .camClose{
      border:none;
      background:transparent;
      font-size:20px;
      font-weight:900;
      color:var(--primary);
    }

    #camVideo{
      width:100%;
      height:55vh;
      background:#000;
      object-fit:cover;
    }

    .camBottom{
      display:flex;
      gap:10px;
      padding:12px 14px;
      border-top:1px solid var(--line);
    }

    .camBtnPrimary{
      flex:1.4;
      height:54px;
      border-radius:14px;
      border:none;
      background:var(--primary);
      color:#fff;
      font-weight:1000;
      font-size:18px;
    }

    .camBtn{
      flex:1;
      height:54px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--primary);
      font-weight:1000;
      font-size:16px;
    }

    .camBtn:disabled,
    .camBtnPrimary:disabled{
      opacity:.45;
    }

    .camMsg{
      margin:0;
      padding:0 14px 14px;
      color:#b91c1c;
      font-weight:800;
      min-height:20px;
    }

    .camModal[hidden]{
      display:none !important;
    }

    .btnRow{
      display:grid;
      gap:10px;
    }

    .btn-secondary{
      width:100%;
      height:64px;
      border-radius:18px;
      border:1px solid rgba(11,92,255,.35);
      background:#fff;
      color:var(--primary);
      font-size:20px;
      font-weight:1000;
    }
  </style>
</body>
</html>
