<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mantenimiento · Postventa Canarias</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0b5cff">
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="topbar">
    <a class="back" href="./nuevo-parte.html" aria-label="Volver">←</a>
    <h1>Mantenimiento</h1>
  </header>

  <main class="container">
    <!-- Cabecera -->
    <section class="card">
      <div class="meta">
        <div><strong>Intervención:</strong> Mantenimiento</div>
        <div><strong>Fecha:</strong> <span id="mFecha">—</span></div>
        <div><strong>ID Cliente:</strong> <span id="mId">—</span></div>
      </div>

      <div class="field onecol" style="margin-top:12px;">
        <label style="font-weight:900; display:block; margin-bottom:6px;">Técnico</label>
        <select id="tec" style="width:100%; height:56px; border-radius:14px; border:1px solid var(--line); font-size:18px; padding:0 12px;">
          <option value="" selected>Selecciona…</option>
          <option value="JUAN PABLO CABRERA PEREZ">JUAN PABLO CABRERA PEREZ</option>
          <option value="DAMASO ROLDAN PEREZ">DAMASO ROLDAN PEREZ</option>
          <option value="PABLO ECHEDEY ESPINO ORTEGA">PABLO ECHEDEY ESPINO ORTEGA</option>
          <option value="YISHAR ROMAN MEDINA">YISHAR ROMAN MEDINA</option>
        </select>
      </div>
    </section>

    <!-- Precio y Material -->
    <section class="card">
      <div class="rowhead">
        <h2>Importes</h2>
        <div class="rate">Fijo + Extras</div>
      </div>

      <div class="field onecol">
        <label>Material (€)</label>
        <input id="material" type="number" inputmode="decimal" step="0.01" placeholder="0,00">
      </div>

      <div class="field onecol">
        <label>Batería</label>
        <select id="bateria" style="width:100%; height:56px; border-radius:14px; border:1px solid var(--line); font-size:18px; padding:0 12px;">
          <option value="0">Sin batería</option>
          <option value="73.15">1 batería (73,15 €)</option>
          <option value="146.30">2 baterías (146,30 €)</option>
        </select>
      </div>

      <div class="sumtotal" style="padding-top:10px;">
        <span>TOTAL</span>
        <strong id="total">99,00 €</strong>
      </div>
    </section>

    <!-- Observaciones -->
    <section class="card">
      <h2>Observaciones</h2>
      <textarea id="obs" rows="4" placeholder="Escribe aquí si hay algo que anotar..."></textarea>
    </section>
    <!-- Fotos Material -->
    <section class="card">
      <h2>Fotos · Material</h2>
      <input id="fotoMaterial" type="file" accept="image/*" capture="environment" multiple style="margin-top:8px;">
    </section>
    <!-- Guardar -->
    <section class="card">
      <div class="btnRow">
        <button id="btnGuardar" class="btn-primary" type="button">GUARDAR (LOCAL)</button>
      </div>

      <p class="msg ok" id="ok" aria-live="polite"></p>
      <p class="msg" id="err" aria-live="polite"></p>
    </section>
  </main>

  <script>
    const EUR = (n) => new Intl.NumberFormat("es-ES", { style:"currency", currency:"EUR" }).format(n);

    const MANTENIMIENTO_FIJO = 99.00;

    const ok = document.getElementById("ok");
    const err = document.getElementById("err");
    const tec = document.getElementById("tec");

    // ------- Cargar cabecera -------
    const header = (() => {
      try { return JSON.parse(localStorage.getItem("pv_header") || "{}"); }
      catch { return {}; }
    })();

    document.getElementById("mFecha").textContent = header.fecha || "—";
    document.getElementById("mId").textContent = header.idCliente || "—";
    document.getElementById("total").textContent = EUR(MANTENIMIENTO_FIJO);
const materialInput = document.getElementById("material");
const bateriaSelect = document.getElementById("bateria");
const totalEl = document.getElementById("total");

const toNum = (v) => Number(v) || 0;

function recalc() {
  const mat = toNum(materialInput.value);
  const bat = toNum(bateriaSelect.value);
  const total = MANTENIMIENTO_FIJO + mat + bat;
  totalEl.textContent = EUR(total);
}

materialInput.addEventListener("input", recalc);
bateriaSelect.addEventListener("change", recalc);
    // Recordar último técnico (para mantenimiento)
    try {
      const last = localStorage.getItem("pv_tecnico_mant") || "";
      if (last) tec.value = last;
    } catch {}

    tec.addEventListener("change", () => {
      try { localStorage.setItem("pv_tecnico_mant", tec.value || ""); } catch {}
    });

    // ------- Guardado local -------
    document.getElementById("btnGuardar").addEventListener("click", () => {
      ok.textContent = "";
      err.textContent = "";

      if (!header.idCliente) {
        err.textContent = "Falta ID Cliente (vuelve atrás y créalo desde Nuevo Parte).";
        return;
      }
      if (!tec.value) {
        err.textContent = "Selecciona un técnico.";
        return;
      }

const savedAt = new Date().toISOString();
const partId = `${header?.fecha || "nodate"}::${header?.idCliente || "noclient"}::mantenimiento::${savedAt}`;

const mat = toNum(materialInput.value);
const bat = toNum(bateriaSelect.value);
const totalFinal = MANTENIMIENTO_FIJO + mat + bat;

const files = Array.from(document.getElementById("fotoMaterial").files || []);
const materialImages = [];

for (const f of files) {
  const data = await new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(f);
  });
  materialImages.push(data);
}

const payload = {
        part_id: partId,
        sent_by: {},
        header: { ...header, tecnico: tec.value || "" },
        tipo: "mantenimiento",
        tarifas: { FIJO: MANTENIMIENTO_FIJO },
        datos: {
          fijo: MANTENIMIENTO_FIJO,
          material: mat,
          bateria: bat
        },
        totales: { total: totalFinal },
        observaciones: document.getElementById("obs").value || "",
        fotos: {
          ticket_count: 0,
          material_count: materialImages.length,
          ticket_dataurls: [],
          material_dataurls: materialImages
        },
        saved_at: savedAt
      };

const key = "pv_partes";
      let arr = [];
      try { arr = JSON.parse(localStorage.getItem(key) || "[]"); } catch {}
      try {
        arr.push(payload);
        localStorage.setItem(key, JSON.stringify(arr));

        const test = JSON.parse(localStorage.getItem(key) || "[]");
        if (!Array.isArray(test) || test.length !== arr.length) throw new Error("Guardado no confirmado");

        try { localStorage.removeItem("pv_header"); } catch {}

        ok.textContent = "Guardado en el móvil ✅";
        setTimeout(() => { window.location.href = "./index.html"; }, 350);
      } catch (e) {
        console.error(e);
        err.textContent = "Error guardando en el teléfono (memoria llena o fallo iOS).";
      }
    });
  </script>

  <style>
    .back{
      position:absolute;
      left:16px;
      top:16px;
      text-decoration:none;
      font-size:22px;
      font-weight:900;
      color:var(--primary);
    }
    .topbar{ position:sticky; }
    .topbar h1{ text-align:center; }

    .meta{ display:grid; gap:8px; font-size:16px; }
    .rowhead{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .rate{ font-weight:900; color:var(--muted); }

    textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 14px;
      font-size:18px;
      font-family:var(--font);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(11,92,255,.45);
      box-shadow: 0 0 0 4px rgba(11,92,255,.12);
    }
    .btnRow{ display:grid; gap:10px; }
  </style>
</body>
</html>
